/*
## Summary
Assigns RCI scores to all journal articles.

## Description
Method: https://github.com/Curtin-Open-Knowledge-Initiative/coki-ries/blob/main/docs/era_2018.md#indicator-relative-citation-impact-rci

The Research Citation Impact for a paper is calculated separately for each FoR (field of research) that the paper contributes to. It is the number of citations for the paper divided by a citation benchmark value for the given FoR and year of publication. If there is no benchmark value available, the RCI is zero. Using year specific benchmarks helps to control somewhat for time bias (papers accumulate more citation over time). Separate RCI scores are assigned against different benchmarks (CPP global, CPP local, CPP HPI).

## Contacts
julian.tonti-filippini@curtin.edu.au

## License
Apache 2.0

## Requires
table core_papers
table benchmarks_cpp_*
table benchmarks_hpi_*

## Creates
table rci_papers
*/
const compile = ({
  project = "",
  dataset = "",
  replace = false,
  version = "",
}) => `
-- generated by: ${require("path").basename(__filename)}
BEGIN
  -- assign RCI scores to each paper, against global CPP, local CPP and global HPI
  ${replace ? "CREATE OR REPLACE TABLE" : "CREATE TABLE IF NOT EXISTS"} \`${project}.${dataset}.rci_papers${version}\` AS (
    WITH assignments AS (
      SELECT DISTINCT paper AS doi, year, field, frac AS weight, cits FROM \`${project}.${dataset}.core_assignments${version}\`
    ) 
    SELECT
      A.doi,
      A.year,
      A.field,
      A.weight,
      IF(B.benchmark = 0 OR B.benchmark IS NULL, 0, A.cits / B.benchmark) AS rci_local,
      IF(C.benchmark = 0 OR C.benchmark IS NULL, 0, A.cits / C.benchmark) AS rci_world,
      IF(D.benchmark = 0 OR D.benchmark IS NULL, 0, A.cits / D.benchmark) AS hpi_world
    FROM assignments AS A
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_local_2_${version}\` AS B ON A.year = B.year AND A.field = B.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_world_2_${version}\` AS C ON A.year = C.year AND A.field = C.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_hpi_world_2_${version}\` AS D ON A.year = D.year AND A.field = D.field 
    WHERE LENGTH(A.field) = 2 

    UNION ALL

    SELECT
      A.doi,
      A.year,
      A.field,
      A.weight,
      IF(B.benchmark = 0 OR B.benchmark IS NULL, 0, A.cits / B.benchmark) AS rci_local,
      IF(C.benchmark = 0 OR C.benchmark IS NULL, 0, A.cits / C.benchmark) AS rci_world,
      IF(D.benchmark = 0 OR D.benchmark IS NULL, 0, A.cits / D.benchmark) AS hpi_world
    FROM assignments AS A
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_local_4_${version}\` AS B ON A.year = B.year AND A.field = B.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_world_4_${version}\` AS C ON A.year = C.year AND A.field = C.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_hpi_world_4_${version}\` AS D ON A.year = D.year AND A.field = D.field 
    WHERE LENGTH(A.field) = 4
  
    /*
    SELECT 
      A.doi,
      A.year_published AS year,
      F.code AS field,
      F.weight AS weight,
      IF(B.benchmark = 0 OR B.benchmark IS NULL, 0, A.num_citations / B.benchmark) AS rci_local,
      IF(C.benchmark = 0 OR C.benchmark IS NULL, 0, A.num_citations / C.benchmark) AS rci_world,
      IF(D.benchmark = 0 OR D.benchmark IS NULL, 0, A.num_citations / D.benchmark) AS hpi_world
    FROM \`${project}.${dataset}.core_papers${version}\` AS A
    LEFT JOIN UNNEST(fors) AS F
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_local_2_${version}\` AS B ON A.year_published = B.year AND F.code = B.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_world_2_${version}\` AS C ON A.year_published = C.year AND F.code = C.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_hpi_world_2_${version}\` AS D ON A.year_published = D.year AND F.code = D.field 
    WHERE LENGTH(field) = 2

    UNION ALL

    SELECT 
      A.doi,
      A.year_published AS year,
      F.code AS field,
      F.weight AS weight,
      IF(B.benchmark = 0 OR B.benchmark IS NULL, 0, A.num_citations / B.benchmark) AS rci_local,
      IF(C.benchmark = 0 OR C.benchmark IS NULL, 0, A.num_citations / C.benchmark) AS rci_world,
      IF(D.benchmark = 0 OR D.benchmark IS NULL, 0, A.num_citations / D.benchmark) AS hpi_world
    FROM \`${project}.${dataset}.core_papers${version}\` AS A
    LEFT JOIN UNNEST(fors) AS F
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_local_4_${version}\` AS B ON A.year_published = B.year AND F.code = B.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp_world_4_${version}\` AS C ON A.year_published = C.year AND F.code = C.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_hpi_world_4_${version}\` AS D ON A.year_published = D.year AND F.code = D.field 
    WHERE LENGTH(field) = 4
    ORDER BY doi,field
    */
  );
END;`;
const compile_all = (args = {}) => [compile(args)];
module.exports = { compile, compile_all };
if (require.main === module) require("app").cli_compile(compile_all);

const compile2 = ({
  project = "",
  dataset = "",
  replace = false,
  version = "",
}) => `
-- generated by: ${require("path").basename(__filename)}
BEGIN
  -- assign RCI scores to each paper, against the benchmark CPP and HPI
  ${replace ? "CREATE OR REPLACE TABLE" : "CREATE TABLE IF NOT EXISTS"} \`${project}.${dataset}.rci_papers${version}\` AS (
    SELECT 
      A.work,
      A.year,
      F.conc,
      F.weight,
      IF(B.benchmark = 0 OR B.benchmark IS NULL, 0, A.num_citations / B.benchmark) AS rci,
      IF(D.benchmark = 0 OR D.benchmark IS NULL, 0, A.num_citations / D.benchmark) AS hpi
    FROM \`${project}.${dataset}.core_papers${version}\` AS A
    LEFT JOIN UNNEST(concs) AS F
    LEFT JOIN \`${project}.${dataset}.benchmarks_cpp${version}\` AS B ON A.year = B.year AND F.code = B.code 
    LEFT JOIN \`${project}.${dataset}.benchmarks_hpi${version}\` AS D ON A.year = D.year AND F.code = D.code 
    ORDER BY work,conc
  );
END;`;
